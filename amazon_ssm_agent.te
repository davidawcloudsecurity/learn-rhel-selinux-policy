module amazon_ssm_agent 1.0;

require {
    type var_log_t;
    type var_lib_t;
    type usr_t;
    type systemd_unit_file_t;
    type bin_t;
    type init_t;
    type amazon_ssm_agent_t;
    type amazon_ssm_agent_exec_t;
    type amazon_ssm_agent_var_lib_t;
    type amazon_ssm_agent_log_t;
    type amazon_ssm_agent_unit_file_t;
    class file { read execute getattr open write append };
    class dir { search open read };
    class service start;
    class process transition;
    class unix_stream_socket connectto;
}

# Define types
type amazon_ssm_agent_t;
type amazon_ssm_agent_exec_t;
type amazon_ssm_agent_var_lib_t;
type amazon_ssm_agent_log_t;
type amazon_ssm_agent_unit_file_t;

# Allow amazon-ssm-agent to run as a daemon
init_daemon_domain(amazon_ssm_agent_t, amazon_ssm_agent_exec_t)

# Allow amazon-ssm-agent to read and write its log files
allow amazon_ssm_agent_t amazon_ssm_agent_log_t:file { read write append };
allow amazon_ssm_agent_t amazon_ssm_agent_log_t:dir { search open read };

# Allow amazon-ssm-agent to read and write its var lib files
allow amazon_ssm_agent_t amazon_ssm_agent_var_lib_t:file { read write append };
allow amazon_ssm_agent_t amazon_ssm_agent_var_lib_t:dir { search open read };

# Allow amazon-ssm-agent to execute its own binaries
allow amazon_ssm_agent_t amazon_ssm_agent_exec_t:file { read execute open };

# Allow amazon-ssm-agent to read its unit file
allow amazon_ssm_agent_t amazon_ssm_agent_unit_file_t:file { read open getattr };

# Allow amazon-ssm-agent to start as a service
allow init_t amazon_ssm_agent_t:service start;

# Allow amazon-ssm-agent to connect to systemd socket (correct type reference)
# Commenting out this line since systemd_socket_proxyd_t may not be defined in your system
# allow amazon_ssm_agent_t systemd_socket_proxyd_t:unix_stream_socket connectto;
